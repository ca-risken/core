name: "Devin PR Review"

on:
  pull_request:
    types: [labeled]

env:
  label_name: epic

jobs:
  devin_pr_review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Request Devin Code Review
        if: ${{ github.event.label.name == env.label_name }}
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          JSON_PAYLOAD=$(cat <<EOF
          {
            "prompt": "Please review this pull request and look for bugs and security issues. PR: ${PR_URL} Only report on bugs and potential vulnerabilities you find. Be concise. Adapt your response language to match the language used in the PR title and description (e.g., if the PR is written in Japanese, respond in Japanese; if in English, respond in English). After completing the review, make sure to run 'gh pr review' to submit your feedback."
          }
          EOF
          )
          curl -X POST "https://api.devin.ai/v1/sessions" \
               -H "Authorization: Bearer $DEVIN_API_KEY" \
               -H "Content-Type: application/json" \
               -d "$JSON_PAYLOAD"