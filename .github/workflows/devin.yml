name: "Devin PR Review"

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  devin_pr_review:
    runs-on: ubuntu-latest
    steps:
      - name: Request Devin Code Review
        if: |
          (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/devin')) ||
          (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '/devin')) ||
          (github.event_name == 'pull_request_review' && contains(github.event.review.body, '/devin'))
        permissions:
          contents: read
          pull-requests: read
          issues: read
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            PR_URL="${{ github.event.issue.pull_request.html_url }}"
          elif [ "${{ github.event_name }}" == "pull_request_review_comment" ]; then
            PR_URL="${{ github.event.comment.pull_request_url }}"
          else
            PR_URL="${{ github.event.review.pull_request_url }}"
          fi
          
          JSON_PAYLOAD=$(cat <<EOF
          {
            "prompt": "Please review this pull request and look for bugs and security issues. PR: ${PR_URL} Only report on bugs and potential vulnerabilities you find. Be concise. Adapt your response language to match the language used in the PR title and description (e.g., if the PR is written in Japanese, respond in Japanese; if in English, respond in English). After completing the review, make sure to run 'gh pr review -c' to submit your feedback."
          }
          EOF
          )
          
          echo "ðŸš€ Requesting Devin code review..."
          
          HTTP_STATUS=$(curl -s -w "%{http_code}\n" -o /dev/null -X POST "https://api.devin.ai/v1/sessions" \
               -H "Authorization: Bearer $DEVIN_API_KEY" \
               -H "Content-Type: application/json" \
               -d "$JSON_PAYLOAD")
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "âŒ API request failed with status code: $HTTP_STATUS"
            exit 1
          fi
          
          echo "âœ… Devin session started successfully"
